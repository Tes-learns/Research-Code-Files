---
title: "Visualize Generated data"
author: "Tes"
date: "2025-11-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Generate data function
```{r function}

generate_mrem_data <- function(K, G, pi_g, mu_g, tau2_g,
                               s2_min = 0.5, s2_max = 1) {
  
  # ---- Check Inputs ----
  if (length(pi_g) != G || length(mu_g) != G || length(tau2_g) != G) {
    stop("Lengths of pi_g, mu_g, and tau2_g must all equal G.")
  }
  
  if (abs(sum(pi_g) - 1) > 1e-6) {
    stop("Mixing proportions pi_g must sum to 1.")
  }
  
  # ---- Step 1: Generate component membership z_i ----
  z_i <- sample(seq_len(G), size = K, replace = TRUE, prob = pi_g)
  
  # ---- Step 2: Generate true effect sizes δ*_i ----
  delta_i <- sapply(z_i, function(g) {
    rnorm(1, mean = mu_g[g], sd = sqrt(tau2_g[g]))
  })
  
  # ---- Step 3: Generate within-study variances s_i² ----
  s2_i <- runif(K, min = s2_min, max = s2_max)
  
  # ---- Step 4: Generate observed effect sizes Y_i ----
  Y_i <- rnorm(K, mean = delta_i, sd = sqrt(s2_i))
  
  # ---- Step 5: Return dataset ----
  data.frame(
    study = seq_len(K),
    component = z_i,
    delta_true = delta_i,
    s2 = s2_i,
    Y = Y_i
  )
}
```




## Scenarios

```{r}
scenarios <- list(
  
  list(
    paper_id = 1,
    G = 1,
    pi_g  = c(1),
    mu_g  = c(0.5),
    tau2_g = c(0.8^2)
  ),
  
  list(
    paper_id = 2,
    G = 2,
    pi_g  = c(0.56, 0.44),
    mu_g  = c(-2.5, 1),
    tau2_g = c(0.6^2, 0.8^2)
  ),
  
  list(
    paper_id = 3,
    G = 3,
    pi_g  = c(0.2, 0.4, 0.4),
    mu_g  = c(-2.5, -1, 2.5),
    tau2_g = c(0.7^2, 0.7^2, 0.6^2)
  ),
  
  list(
    paper_id = 4,
    G = 4,
    pi_g  = c(0.2, 0.3, 0.3, 0.2),
    mu_g  = c(-4, -2.5, 1, 3.5),
    tau2_g = c(0.8^2, 0.8^2, 0.6^2, 0.6^2)
  )
)
```


```{r}
library(ggplot2)
library(dplyr)

set.seed(315)

K_vis  <- 1500
n_runs <- 3

all_vis_data <- list()

for (sc in scenarios) {
  
  for (r in 1:n_runs) {
    
    dat <- generate_mrem_data(
      K = K_vis,
      G = sc$G,
      pi_g = sc$pi_g,
      mu_g = sc$mu_g,
      tau2_g = sc$tau2_g
    )
    
    vis_df <- data.frame(
      delta_true = dat$delta_true,
      Y = dat$Y,
      scenario = paste0("Scenario ", sc$paper_id),
      run = paste0("Run ", r)
    )
    
    all_vis_data[[length(all_vis_data) + 1]] <- vis_df
  }
}

plot_data <- bind_rows(all_vis_data)


```

### Plot of Observed Effect sizes and Random Effects
#### Density of $$Y_i$$
```{r}
ggplot(plot_data, aes(x = Y)) +
  geom_density(fill = "#e31a1c", alpha = 0.6) +
  facet_grid(scenario ~ run) +
  labs(x = expression(Y[i]),
       y = "Density",
       title = "Distribution of Observed Study-Specific Effects") +
  theme_bw() +
  theme(strip.text = element_text(face = "bold"))


```

#### Density of $$\delta_i$$

```{r}
ggplot(plot_data, aes(x = delta_true)) +
  geom_density(fill = "#1f78b4", alpha = 0.6) +
  facet_grid(scenario ~ run) +
  labs(x = expression(delta[i]),
       y = "Density",
       title = "Distribution of True Study-Specific Effects") +
  theme_bw() +
  theme(strip.text = element_text(face = "bold"))

```

